<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>iclGPU: Intel Compute Library for GPU Core library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">iclGPU
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Intel Compute Library for GPU Core library </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>How to define and implement a new function:</h2>
<h3>Step 1: Create function definition using functions definition syntax described below. For example:</h3>
<div class="fragment"><div class="line">function copy_float {</div><div class="line">   params {</div><div class="line">        uint n,</div><div class="line">        blob input float src,</div><div class="line">        blob output float dst</div><div class="line">    },</div><div class="line">    implementations {</div><div class="line">        naive</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3>Step 2: Run autogenerator:</h3>
<div class="fragment"><div class="line">core/tools/functions_hpp_gen.py &lt;definition-file&gt; &lt;implementations-dir&gt; &lt;headers-dir&gt;</div></div><!-- fragment --><p> e.g.:</p>
<div class="fragment"><div class="line">core/tools/functions_hpp_gen.py functions.def . .</div></div><!-- fragment --><p>Following files will be created:</p>
<h4>The function header</h4>
<p><em>copy_float.hpp</em> - <b>should not be modified</b>:</p>
<div class="fragment"><div class="line"><span class="comment">// copy_float function autogenerated file </span></div><div class="line"><span class="preprocessor">#pragma once</span></div><div class="line"><span class="preprocessor">#include &quot;functions_base.hpp&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceiclgpu.html">iclgpu</a> { <span class="keyword">namespace </span>functions {</div><div class="line"><span class="keyword">struct </span>copy_float</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keyword">struct </span>params</div><div class="line">    {</div><div class="line">        uint32_t n;</div><div class="line">        blob&lt;float, input&gt; src;</div><div class="line">        blob&lt;float, output&gt; dst;</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="keyword">struct </span>score : <span class="keyword">public</span> function_score&lt;params_num&gt;</div><div class="line">    {</div><div class="line">        <span class="keywordtype">float</span>&amp; n;</div><div class="line">        <span class="keywordtype">float</span>&amp; src;</div><div class="line">        <span class="keywordtype">float</span>&amp; dst;</div><div class="line">        ...</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="keyword">using</span> impl = function_impl_execute&lt;copy_float&gt;;</div><div class="line">    <span class="keyword">using</span> selector = selector_accept&lt;copy_float&gt;;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">namespace </span>implementations</div><div class="line">{</div><div class="line"><span class="keyword">struct </span>copy_float_naive : copy_float::impl</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordtype">bool</span> accept(<span class="keyword">const</span> copy_float::params&amp; params, copy_float::score&amp; score) <span class="keyword">override</span>;</div><div class="line">    <span class="keyword">event</span> execute(<span class="keyword">const</span> copy_float::params&amp; params, <span class="keyword">const</span> std::vector&lt;event&gt;&amp; dep_events) <span class="keyword">override</span>;</div><div class="line">};</div><div class="line">}</div><div class="line">...</div><div class="line">} } <span class="comment">// namespace iclgpu::functions</span></div><div class="line"><span class="comment">// End of copy_float autogenerated</span></div></div><!-- fragment --><h4>The <b>OpenCL</b> kernel module for the function implementation <b>naive</b></h4>
<p><em>copy_float/copy_float_naive.cl</em>: </p><div class="fragment"><div class="line">__kernel void copy_float_naive(int n, __global float* src, __global float* dst)</div><div class="line">{</div><div class="line">    // TODO Add implementation code here:</div><div class="line">}</div></div><!-- fragment --><h4>The C++ implementation code for the function implementation <b>naive</b></h4>
<p><em>copy_float/copy_float_naive.cpp</em>: </p><div class="fragment"><div class="line">...</div><div class="line">namespace <a class="code" href="namespaceiclgpu.html">iclgpu</a> { <span class="keyword">namespace </span>functions { <span class="keyword">namespace </span>implementations {</div><div class="line"></div><div class="line"><span class="keywordtype">bool</span> copy_float_naive::accept(<span class="keyword">const</span> copy_float::params&amp; params, copy_float::score&amp; score)</div><div class="line">{</div><div class="line">    <span class="comment">// TODO Add implementation code here:</span></div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">event</span> copy_float_naive::execute(<span class="keyword">const</span> copy_float::params&amp; params, <span class="keyword">const</span> std::vector&lt;event&gt;&amp; dep_events)</div><div class="line">{</div><div class="line">    <span class="comment">// TODO Modify implementation code here:</span></div><div class="line">    <span class="keyword">auto</span> engine = context()-&gt;get_engine();</div><div class="line">    <span class="keyword">auto</span> kernel = engine-&gt;get_kernel(kernel_name, module_name);</div><div class="line">    <span class="keywordtype">size_t</span> buf_size = 1;</div><div class="line"></div><div class="line">    kernel-&gt;set_arg(0, params.n);</div><div class="line">    <span class="keyword">auto</span> buf_src = engine-&gt;get_input_buffer(params.src, buf_size);</div><div class="line">    kernel-&gt;set_arg(1, buf_src);</div><div class="line">    <span class="keyword">auto</span> buf_dst = engine-&gt;get_output_buffer(params.dst, buf_size);</div><div class="line">    kernel-&gt;set_arg(2, buf_dst);</div><div class="line"></div><div class="line">    <span class="keyword">auto</span> gws = nd_range(1);</div><div class="line">    <span class="keyword">auto</span> lws = null_range;</div><div class="line">    <span class="keyword">auto</span> options = kernel_options(gws, lws);</div><div class="line">    kernel-&gt;set_options(options);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> kernel-&gt;submit(dep_events);</div><div class="line">}</div><div class="line"></div><div class="line">} } } <span class="comment">// namespace iclgpu::functions::implementations</span></div></div><!-- fragment --><h3>Step 3: Write OpenCL kernel for the function implementation in <em>copy_float_my_impl.cl</em></h3>
<div class="fragment"><div class="line">__kernel void copy_float_naive(__global float* src, __global float* dst)</div><div class="line">{</div><div class="line">    gid = get_global_id(0);</div><div class="line">    dst[gid] = src[gid];</div><div class="line">}</div></div><!-- fragment --> <blockquote class="doxtable">
<p>NOTE: Kernel parameter <b>n</b> is removed. </p>
</blockquote>
<h3>Step 4: Modify <em>copy_float_my_impl.cpp</em> :</h3>
<ol type="1">
<li>Write code for <b>accept()</b> method to correctly validate parameters.</li>
<li>Modify <b>execute()</b> method to properly call the kernel written in _.cl_ file.</li>
</ol>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> copy_float_naive::accept(<span class="keyword">const</span> copy_float::params&amp; params, copy_float::score&amp; score)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">event</span> copy_float_naive::execute(<span class="keyword">const</span> copy_float::params&amp; params, <span class="keyword">const</span> std::vector&lt;event&gt;&amp; dep_events)</div><div class="line">{</div><div class="line">    <span class="keyword">auto</span> engine = context()-&gt;get_engine();</div><div class="line">    <span class="keyword">auto</span> kernel = engine-&gt;get_kernel(kernel_name, module_name);</div><div class="line">    <span class="keywordtype">size_t</span> buf_size = params.n;</div><div class="line"></div><div class="line">    <span class="keyword">auto</span> buf_src = engine-&gt;get_input_buffer(params.src, buf_size);</div><div class="line">    kernel-&gt;set_arg(0, buf_src);</div><div class="line">    <span class="keyword">auto</span> buf_dst = engine-&gt;get_output_buffer(params.dst, buf_size);</div><div class="line">    kernel-&gt;set_arg(1, buf_dst);</div><div class="line"></div><div class="line">    <span class="keyword">auto</span> gws = nd_range(buf_size);</div><div class="line">    <span class="keyword">auto</span> lws = null_range;</div><div class="line">    <span class="keyword">auto</span> options = kernel_options(gws, lws);</div><div class="line">    kernel-&gt;set_options(options);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> kernel-&gt;submit(dep_events);</div><div class="line">}</div></div><!-- fragment --> <blockquote class="doxtable">
<p>NOTE: Kernel parameter <b>n</b> is removed and indexes for <b>src</b> and <b>dst</b> parameters are decremented. </p>
</blockquote>
<h3>Step 5: Execute function implementation:</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iclgpu/context.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iclgpu/dispatcher.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;copy_float.hpp&quot;</span></div><div class="line">...</div><div class="line">uint n = 5;</div><div class="line"><span class="keywordtype">float</span> src[5] = { 1.f, 2.f, 3.f, 4.f, 5.f };</div><div class="line"><span class="keywordtype">float</span> dst[5];</div><div class="line"></div><div class="line">iclgpu::functions::copy_float::params params{ n, src, dst };</div><div class="line"><a class="code" href="classiclgpu_1_1context.html#aeec6c9d0f6f38dd2cddee6e717bfd541">iclgpu::context::create</a>()</div><div class="line">    -&gt;get_dispatcher()</div><div class="line">    -&gt;execute_function&lt;iclgpu::functions::copy_float&gt;(params)</div><div class="line">    -&gt;wait();</div></div><!-- fragment --><h4>Note</h4>
<blockquote class="doxtable">
<p>The function sources autogenerator does not modify existing _.cpp_ and _.cl_ files. </p>
</blockquote>
<h2>Functions definition syntax</h2>
<p><em>struct_definition</em> | <em>func_definiton</em>...</p>
<p><em>struct_definition</em> =&gt; <b>struct</b> <em>class_name</em> '{' <em>scalar_type</em> <em>field_name</em> [',' <em>scalar_type</em> <em>field_name</em>...] '}'</p>
<p><em>func_definiton</em> =&gt; <b>function</b> <em>class_name</em> '{' <em>params_def</em>, <em>impls_def</em> '}'</p>
<p><em>scalar_type</em> =&gt; <em>simple_type</em> | <b>struct</b> <em>class_name</em></p>
<p><em>simple_type</em> =&gt; <b>char|uchar|short|ushort|int|uint|long|ulong|float|double</b></p>
<p><em>params_def</em> =&gt; <b>params</b> '{' <em>param_type</em> <em>field_name</em> [',' <em>param_type</em> <em>field_name</em>...] '}'</p>
<p><em>param_type</em> =&gt; <em>blob_type</em>|*scalar_type*</p>
<p><em>blob_type</em> =&gt; <b>blob</b> [<b>input|output|inout</b>] <b>void</b> | <em>scalar_type</em></p>
<p><em>impls_def</em> =&gt; <b>implementations</b> '{' <em>class_name</em>[',' <em>class_name</em>...] '}'</p>
<p><em>class_name</em> =&gt; <em>word allowed for C++ class/structure name</em></p>
<p><em>field_name</em> =&gt; <em>word allowed for C++ class/structure data member name</em> </p><hr/>
<p>Copyright &copy; 2018, Intel&reg; Corporation </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
